<!DOCTYPE html><html class="has-navbar-fixed-top"><head><meta charset="utf-8"><title>遠端控制內網電腦 - BRChen home</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><meta name="keywords" content="blog"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="/css/style.css"><script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script></head><body><nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo.png" alt="" height="28"></a><div class="navbar-burger"><span></span> <span></span> <span></span></div></div><div class="navbar-menu navbar-end"></div></div></nav><section class="section"><div class="container"><article class="article content gallery" itemscope itemprop="blogPost"><h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">遠端控制內網電腦</h1><div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile"><span class="column is-narrow"><time datetime="2019-10-19T05:18:09.000Z" itemprop="datePublished">Oct 19 2019</time> </span><span class="column is-narrow article-category"><i class="far fa-folder"></i> <a class="article-category-link" href="/categories/Web/">Web</a> </span><span class="column is-narrow">7 minutes read (About 999 words)</span></div><div class="article-entry is-size-6-mobile" itemprop="articleBody"><h2 id="緣由"><a href="#緣由" class="headerlink" title="緣由"></a>緣由</h2><p>有時會有學習或工作用的電腦沒有實體 IP (在內網)，但又需要連線到那台電腦<br>這時可以利用 Reverse SSH Tunneling 機制來連線</p><h2 id="所需環境與工具"><a href="#所需環境與工具" class="headerlink" title="所需環境與工具"></a>所需環境與工具</h2><ol><li><p>一台有實體 IP 的伺服器<br>如沒有可購買 VPS，如 <a href="https://www.linode.com/" target="_blank" rel="noopener">Linode</a>，最便宜方案一個月 5 美金</p></li><li><p><a href="https://www.openssh.com/" target="_blank" rel="noopener">OpenSSH</a><br>Linux 有內建<br>Windows 10 可從 <a href="https://jcutrer.com/windows/install-openssh-on-windows10" target="_blank" rel="noopener">設定</a> 來啟用</p></li><li><p><a href="https://www.harding.motd.ca/autossh/" target="_blank" rel="noopener">autossh</a> (選用)</p></li></ol><h2 id="範例環境介紹"><a href="#範例環境介紹" class="headerlink" title="範例環境介紹"></a>範例環境介紹</h2><table><thead><tr><th align="center">Machine</th><th align="center">Account</th><th align="center">IP</th><th align="center">Port</th><th align="center">Info</th></tr></thead><tbody><tr><td align="center">ServerA</td><td align="center">userA</td><td align="center">192.168.0.101</td><td align="center">22</td><td align="center">Private IP (內網；目標電腦)</td></tr><tr><td align="center">ServerB</td><td align="center">userB</td><td align="center">149.12.34.56</td><td align="center">1234</td><td align="center">Public IP (外網；中繼電腦)</td></tr><tr><td align="center">Client</td><td align="center">user</td><td align="center"></td><td align="center"></td><td align="center">User (你的電腦)</td></tr></tbody></table><p>你想從 Client 這台電腦連到工作用的電腦 ServerA，預期連線流程大概如下:</p><p></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client -----&gt; ServerB --| 防火牆 |--&gt; ServerA</span><br></pre></td></tr></table></figure><p></p><p>又因為 ServerA 沒有實體 IP，ServerB 無法直接連到 ServerA<br>可以利用 Reverse SSH Tunneling 機制<br>ServerA 先連到 ServerB 建立隧道:</p><p></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServerB &lt;==| 防火牆 |== ServerA</span><br></pre></td></tr></table></figure><p></p><p>ServerB 再依靠該隧道 port 1234 連到 ServerA:</p><p></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServerB ≡≡| 防火牆 |≡≡&gt; ServerA</span><br></pre></td></tr></table></figure><p></p><h2 id="免密碼登入"><a href="#免密碼登入" class="headerlink" title="免密碼登入"></a>免密碼登入</h2><p>連線時會需要帳密<br>如果想免密碼登入可執行此步驟把 public key 傳給對方</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[userA@ServerA] $ ssh-keygen <span class="hljs-comment"># 產一對 key</span></span><br><span class="line">[userA@ServerA] $ ssh-copy-id -i ~/.ssh/id_rsa.pub userB@149.12.34.56   <span class="hljs-comment"># 把 public key 送給對方</span></span><br></pre></td></tr></table></figure><p></p><h2 id="目標電腦設定"><a href="#目標電腦設定" class="headerlink" title="目標電腦設定"></a>目標電腦設定</h2><p>Server A 開一個隧道到 ServerB</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[userA@ServerA] $ ssh -NfR 1234:localhost:22 userB@149.12.34.56    <span class="hljs-comment"># f 代表背景執行</span></span><br></pre></td></tr></table></figure><p></p><h2 id="連到目標電腦"><a href="#連到目標電腦" class="headerlink" title="連到目標電腦"></a>連到目標電腦</h2><h3 id="方法-1"><a href="#方法-1" class="headerlink" title="方法 1"></a>方法 1</h3><p>Client 先連到 ServerB</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[user@Client] $ ssh userB@149.12.34.56</span><br></pre></td></tr></table></figure><p></p><p>因為前面 ServerA 已經開一個隧道過來<br>所以 ServerB 就能連到 ServerA 了</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[userB@ServerB] $ ssh userA@localhost -p 1234</span><br></pre></td></tr></table></figure><p></p><h3 id="方法-2"><a href="#方法-2" class="headerlink" title="方法 2"></a>方法 2</h3><p>使用一個指令來達成 “先連到 ServerB 再下指令連到 ServerA”</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[user@Client] $ ssh -t userB@149.12.34.56 <span class="hljs-string">"ssh userA@localhost -p 1234"</span></span><br></pre></td></tr></table></figure><p></p><h3 id="方法-3"><a href="#方法-3" class="headerlink" title="方法 3"></a>方法 3</h3><p>直接以 ServerB 當跳板連到 ServerA</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[user@Client] $ ssh -o <span class="hljs-string">"ProxyJump userB@149.12.34.56"</span> userA@localhost -p 1234</span><br></pre></td></tr></table></figure><p></p><p>或是</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[user@Client] $ ssh -J userB@149.12.34.56 userA@localhost -p 1234</span><br></pre></td></tr></table></figure><p></p><h3 id="方法-4-推薦"><a href="#方法-4-推薦" class="headerlink" title="方法 4 (推薦)"></a>方法 4 (推薦)</h3><p>原本 ServerB 只能透過 localhost 來連到 ServerA<br>此方法是 Server A 設定時加上 “-g” 這個 option<br>(允許遠端主機連到本地的轉發 port)<br>讓 Client 透過 ServerB 的 port 直連到 ServerA</p><ol><li><p>仿照前面 <a href="#目標電腦設定">開隧道</a> 時 ServerA 改下指令：</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[userA@ServerA] $ ssh -gNfR 0.0.0.0:1234:localhost:22 userB@149.12.34.56</span><br></pre></td></tr></table></figure><p></p></li><li><p>ServerB 要設定 GatewayPorts：</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[userB@ServerB] $ vim /etc/sshd_config</span><br></pre></td></tr></table></figure><p></p><p>裡面的 “GatewayPorts” 改成 yes (預設是 no) 並重開 sshd 服務:</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[userB@ServerB] $ systemctl restart sshd</span><br></pre></td></tr></table></figure><p></p></li><li><p>去防火牆把中繼 port 設為允許 (ssh 是 tcp)</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[userB@ServerB] $ iptables -A INPUT -i eth0 -p tcp --dport 1234 -j ACCEPT</span><br></pre></td></tr></table></figure><p></p><p>把 iptables 設定存起來</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[userB@ServerB] $ iptables-save</span><br></pre></td></tr></table></figure><p></p></li><li><p>Client 下指令 (記得這邊 account 要填 ServerB 的登入帳號)</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[user@Client] $ ssh userB@149.12.34.56 -p 1234</span><br></pre></td></tr></table></figure><p></p></li></ol><h2 id="其他相關指令"><a href="#其他相關指令" class="headerlink" title="其他相關指令"></a>其他相關指令</h2><h3 id="查看網路狀態"><a href="#查看網路狀態" class="headerlink" title="查看網路狀態"></a>查看網路狀態</h3><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -a|less       <span class="hljs-comment"># less 代表翻頁檢視</span></span><br></pre></td></tr></table></figure><p></p><h3 id="登出"><a href="#登出" class="headerlink" title="登出"></a>登出</h3><p>登入後如果想登出可執行以下指令：</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="hljs-built_in">exit</span></span><br></pre></td></tr></table></figure><p></p><h3 id="關閉-SSH-Tunnel"><a href="#關閉-SSH-Tunnel" class="headerlink" title="關閉 SSH Tunnel"></a>關閉 SSH Tunnel</h3><p>以下為列出 process 資訊的指令：</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ps -ef|grep 1234      <span class="hljs-comment"># 列出使用 1234 port 的 process</span></span><br><span class="line">$ ps aux|less           <span class="hljs-comment"># 列出正在進行的 process</span></span><br><span class="line">$ ps aux|grep ssh       <span class="hljs-comment"># 列出 ssh 相關的 process</span></span><br></pre></td></tr></table></figure><p></p><p>找到 process id 後就能刪除：</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="hljs-built_in">kill</span> -9 [process id]  <span class="hljs-comment"># 刪除指定 process id 的 process</span></span><br></pre></td></tr></table></figure><p></p><h2 id="斷線時自動重連"><a href="#斷線時自動重連" class="headerlink" title="斷線時自動重連"></a>斷線時自動重連</h2><p>有連線就有可能斷線<br>這時候 serverA 就可以用 autossh 來建立 Reverse SSH Tunneling:</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># -M 後面是監聽用的 port, 不可跟 localhost 前的 port 一樣, 設 0 代表強制關閉</span></span><br><span class="line">[userA@ServerA] $ autossh -M 0 -o ServerAliveInterval=10 -o ExitOnForwardFailure=yes -gNfR 1234:localhost:22 userB@149.12.34.56</span><br></pre></td></tr></table></figure><p></p><p>或是可使用 <a href="https://www.npmjs.com/package/cmd-boost" target="_blank" rel="noopener">cmd-boost</a> 這個工具</p><p>如果要關閉 autossh：</p><p></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pkill -3 autossh</span><br></pre></td></tr></table></figure><p></p><h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ol><li><a href="https://easylife.tw/2043" target="_blank" rel="noopener">Reverse SSH Tunnel實際運用，搭配auotssh永不斷線，putty建立反向tunnel</a></li><li><a href="http://blog.codylab.com/cmd-ssh-copy-id/" target="_blank" rel="noopener">實現免密碼 ssh 登入遠端主機</a></li><li><a href="https://blog.urfix.com/25-ssh-commands-tricks/" target="_blank" rel="noopener">25 Best SSH Commands / Tricks</a></li><li><a href="https://www.xiebruce.top/650.html" target="_blank" rel="noopener">ssh通过代理登录远程主机及穿越跳板机</a></li><li><a href="https://www.howtogeek.com/428413/what-is-reverse-ssh-tunneling-and-how-to-use-it/" target="_blank" rel="noopener">What Is Reverse SSH Tunneling? (and How to Use It)</a></li><li><a href="https://www.zhoumingzhi.com/2013/05/17/reverse-ssh-tunneling/" target="_blank" rel="noopener">SSH反向代理使用心得</a></li><li><a href="https://askubuntu.com/questions/50064/reverse-port-tunnelling" target="_blank" rel="noopener">Reverse port tunnelling</a></li><li><a href="https://www.ssh.com/ssh/command/" target="_blank" rel="noopener">SSH COMMAND</a></li></ol></div><div class="columns is-variable is-1 is-multiline is-mobile"><span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/%E6%93%8D%E4%BD%9C/">#操作</a></span></div><div class="columns is-mobile is-multiline article-nav"><span class="column is-12-mobile is-half-desktop article-nav-prev"><a href="/2019/10/%E5%BB%BA%E7%BD%AE%E7%B6%B2%E7%AB%99%E8%A8%98%E9%8C%842-%E5%90%84%E7%A8%AE%E8%A8%AD%E5%AE%9A/">建置網站記錄2-各種設定</a> </span><span class="column is-12-mobile is-half-desktop article-nav-next"><a href="/2019/10/2019-%E9%9D%A2%E8%A9%A6%E7%B4%80%E9%8C%84/">2019 面試紀錄</a></span></div></article></div></section><footer class="footer"><div class="container"><div class="columns content"><div class="column is-narrow has-text-centered">&copy; 2019 brchen777&nbsp; Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos" target="_blank" rel="noopener">Minos</a></div><div class="column is-hidden-mobile"></div></div></div></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update my browser now</a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p></div><script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script><script>$(document).ready(function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"flex"})})</script><script>window.FontAwesomeConfig={searchPseudoElements:!0},moment.locale("en-AU")</script><script src="/js/script.js"></script></body></html>